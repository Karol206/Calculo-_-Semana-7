<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Derivadas Paso a Paso</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f9f9f9;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
    }
    #steps {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Derivada usando la definición (paso a paso)</h1>
  <label>Ingresa una función (por ejemplo: 2*x^2):</label><br>
  <input type="text" id="funcion" placeholder="Ej: 2*x^2" size="30">
  <button onclick="resolver()">Resolver</button>

  <div id="steps"></div>

  <canvas id="grafica" width="600" height="400"></canvas>

  <script>
    function resolver() {
      const input = document.getElementById("funcion").value;
      const steps = document.getElementById("steps");
      steps.innerHTML = "";

      try {
        const f_x = math.parse(input);  // f(x)
        const f_x_str = f_x.toString();

        // Paso 1: f(x)
        steps.innerHTML += `Paso 1: f(x) = ${f_x_str}\n`;

        // Paso 2: f(x+h)
        const xph = math.simplify(input.replace(/x/g, "(x + h)")).toString();
        steps.innerHTML += `Paso 2: f(x + h) = ${xph}\n`;

        // Paso 3: f(x + h) - f(x)
        const diferencia = math.simplify(`(${xph}) - (${f_x_str})`).toString();
        steps.innerHTML += `Paso 3: f(x + h) - f(x) = ${diferencia}\n`;

        // Paso 4: Cociente [f(x + h) - f(x)] / h
        const cociente = math.simplify(`(${diferencia}) / h`).toString();
        steps.innerHTML += `Paso 4: Cociente = (${diferencia}) / h = ${cociente}\n`;

        // Paso 5: Límite cuando h → 0
        const derivada = math.derivative(input, 'x').toString();
        steps.innerHTML += `Paso 5: Derivada final (lim h→0) = ${derivada}\n`;

        // Graficar
        graficarFunciones(input, derivada);
      } catch (error) {
        steps.innerHTML = "⚠️ Error en la función. Asegúrate de escribirla correctamente.";
      }
    }

    function graficarFunciones(fx, dfx) {
      const ctx = document.getElementById("grafica").getContext("2d");

      const f = math.compile(fx);
      const df = math.compile(dfx);

      const labels = [];
      const datosF = [];
      const datosDF = [];

      for (let x = -10; x <= 10; x += 0.5) {
        labels.push(x.toFixed(1));
        datosF.push(f.evaluate({ x }));
        datosDF.push(df.evaluate({ x }));
      }

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "f(x)",
              data: datosF,
              borderColor: "blue",
              fill: false
            },
            {
              label: "f'(x)",
              data: datosDF,
              borderColor: "red",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: {
              display: true,
              text: "Función y su derivada"
            }
          }
        }
      });
    }
  </script>
</body>
</html>
